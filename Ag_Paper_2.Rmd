---
title: "Ag_Paper_2"
author: "Tristan Hanon & Shanchao Wang"
date: "11/12/2018"
output: pdf_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = F,message = F)
# set chuck directory to github directory 
knitr::opts_knit$set(root.dir = "/Users/shanchao/Desktop/Davis/Quarters/2018 Fall/ARE 231/hw/Ag_Paper_2")
library(readstata13)
library(tidyverse)
library(stargazer)
library(broom)
library(ggplot2)
library(rms)
library(sandwich)
library(lmtest)
library(AER)
```

```{r read dta from local directory}
setwd("/Users/shanchao/Desktop/Davis/Quarters/2018 Fall/ARE 231/hw/paper2/aau024_Supplementary_Data/Crop Supply Dynamics/")
rotdata = read.dta13("dyn_supply_rot_1year.dta")
```

```{r replicate paper elasticity estimates}
xlist     = c("p_c","p_s","trend","clay_perc","silt_perc","slopegradwta","precip0405_binary","irr_share")
rotdata1  = rotdata %>% filter(is.na(my_sample_rot)==F) # drop variable with NA my_sample_rot
rotdata1  = rotdata1 %>% mutate(my_reg_rot = group_indices_(rotdata1,.dots = c("my_sample_rot","my_mlra"))) # create my_reg_rot
summary(rotdata1$my_reg_rot[which(rotdata1$sample_cs==1)]) # never monoculture sample indices from 25 to 48
nevermono = min(summary(rotdata1$my_reg_rot[which(rotdata1$sample_cs==1)])) 
rotdata1  = rotdata1 %>% mutate(my_reg_rot = ifelse(my_reg_rot>=nevermono,nevermono,my_reg_rot)) # change never monoculture to 25

for (i in min(unique(rotdata1$my_reg_rot)):(nevermono-1)){
  for(j in 0:1){
    res  = lm(as.formula(paste("corn~", paste(xlist, collapse="+"))),
             data = filter(rotdata1,sample_mon==1 & my_reg_rot == i & lcorn== j),
             weights = ac_clu)
    rows = which(rotdata1$sample_mon==1 & rotdata1$my_reg_rot == i)
    cols = which(colnames(rotdata1) == paste0("cons_lstate",j)):which(colnames(rotdata1) == paste0("me_irr_lstate",j))
    rotdata1[rows,cols] = matrix(rep(as.numeric(summary(res)$coefficients[,"Estimate"]),length(rows)),nrow = length(rows),byrow = T) # fill in estimates for equation (14) and (15)
    rotdata1[rows,which(colnames(rotdata1) == paste0("prob_corn_lstate",j))]  = predict(res,rotdata1[rows,])
    rows = which(rotdata1$sample_mon==1 & rotdata1$my_reg_rot == i & rotdata1$lcorn == j)
    rotdata1[rows,which(colnames(rotdata1) == "xb")]                          = predict(res)
    rotdata1[rows,which(colnames(rotdata1) == "epshat")]                      = resid(res)
  }
}
####################### Never Monoculture
rows = which(rotdata1$sample_cs==1)
for (i in 0:1){
  rotdata1[rows,paste0(c("me_pc_lstate","me_ps_lstate","me_trend_lstate"),i)] = 0
}
rotdata1[rows,"prob_corn_lstate1"] = 0
rotdata1[rows,"prob_corn_lstate0"] = 1
rotdata1[rows,"xb"] = rotdata1[rows,"corn"]
rotdata1[rows,"epshat"] = 0

####################### Calculate Phis
rotdata1 = rotdata1 %>% mutate(P11 = prob_corn_lstate1, P01 = prob_corn_lstate0,
                               me_P11_pc = me_pc_lstate1, me_P01_pc = me_pc_lstate0,
                               me_P11_ps = me_ps_lstate1, me_P01_ps = me_ps_lstate0) %>%
                        mutate(lr_prob_corn=P01/(1-P11+P01),
                               me_lr_pc=(me_P01_pc*(1-P11)+me_P11_pc*P01)/(1-P11+P01)^2,
                               me_lr_ps=(me_P01_ps*(1-P11)+me_P11_ps*P01)/(1-P11+P01)^2,
                               me_sr_pc=  me_P11_pc*lr_prob_corn + me_P01_pc*(1-lr_prob_corn),
                               me_sr_ps=  me_P11_ps*lr_prob_corn + me_P01_ps*(1-lr_prob_corn))

##################### Table 3

```

























